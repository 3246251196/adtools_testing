#!/bin/bash --

set -o pipefail

BASE_DIR="$(pwd)/build"
ORIG_DIR="$(pwd)"
# Exported because this variable is used by the testing framework
export CROSS_PREFIX="${BASE_DIR}"/4afx/4afx_build

function _error
{
    echo "#####"
    echo "ERROR: ${1}" 1>&2
    echo "#####"
    exit "${2}"
}

function _warn
{
    echo "#####"
    echo "WARN: ${1}" 1>&2
    echo "#####"
}

function _info
{
    echo "#####"
    echo "INFO: ${1}"
    echo "#####"
    sleep 1
}

function BUILD
{
    if [[ -z ${CORES} ]]
    then
	CORES=$(nproc)
    fi
    if [[ -z ${CORES} ]] ; then CORES=1 ; fi

    EXP_CLIB2=1  make -j${CORES} -C native-build/ gcc-cross  2>&1 | tee "${BASE_DIR}"/4afx/4afx.log \
	|| _error "The compilation failed. See the log file: \"${BASE_DIR}\"/4afx/4afx.log" 40
}

###
# Step 0: clone ADTOOLS for use with afxgroup CLIB2, build for 11.3 GCC and 2.23.2 binutils
###
which ppc-amigaos-gcc  && _error "Remove existing ADTOOLS from your current path" 10 ;
###
# Step 0.1: ensure that GCC at least exists on the machine running this script
#           and check the environment
###
native_gcc_error=0
which gcc 1>/dev/null 2>&1
if (( !${?} ))
then
    if [[ $(gcc -dumpmachine) != "x86_64-linux-gnu" ]]
    then
	native_gcc_error=1
    fi
else
    native_gcc_error=1
fi
   
if (( native_gcc_error ))
then
    _error "Expected native linux x86-64 gcc compiler to be accessible" 11
fi

# Clear any of these variables in the unlikely event they are set. If not, then
# they are picked up during the building ADTOOLS and they may not point to the
# native gcc that we just tested for before.
export CC=
export CFLAGS=
export CXX=
export CXXFLAGS=
export CPPFLAGS=
export AR=
export AS=
export LD=
export RANLIB=

###
# End Step 0.1
###

if (( $# >= 1 ))
then
    if [[ "${1}" != "rebuild" ]]
    then
	_info "All other arguments will be passed to tests/Makefile"
    fi
fi

if [[ ! -d "${BASE_DIR}" ]]
then
   mkdir "${BASE_DIR}"
   cd "${BASE_DIR}"
   mkdir 4afx
   cd 4afx
   git clone https://github.com/sba1/adtools.git 4afx_adtools
   cd 4afx_adtools

   git submodule init
   git submodule update
   gild/bin/gild checkout binutils 2.23.2
   gild/bin/gild checkout gcc 11

   # We shall use the rs6k amigaos.h version from the afxgroup CLIB2
   sed -i '115i\	cp downloads/clib2/misc/amigaos.h ../gcc/repo/gcc/config/rs6000/' native-build/makefile
   # And, we need to remove -Werror when building clib2 due to time cast issue
   sed -i '115i\	sed -i "s|-Werror|# -Werror|g" downloads/clib2/GNUmakefile.os4' native-build/makefile
   # We also want to build SHARED LIBRARIES for CLIB2
   sed -i 's|SHARED=no|SHARED=yes|' native-build/makefile

   BUILD
else
    if [[ "${1}" == "rebuild" ]]
    then
	cd "${BASE_DIR}/4afx/4afx_adtools" || \
	    _error "Requested a rebuild but there is no directory named \"${BASE_DIR}\". Rerun with out the \"rebuild\" argument" 20
	BUILD
    else
	_warn "\"${BASE_DIR}\" already exists, assuming that you just want to re-run the tests"
    fi
fi

cd "$ORIG_DIR"
###
# Step 1: Run some test programs
###
export PATH="${BASE_DIR}"/4afx/4afx_build/bin:"${PATH}"
# Arbitrary check
which ppc-amigaos-gcc 1>/dev/null 2>&1 || _error "Expected to find the cross GCC compiler on the path" 30

_info "Running tests in $(pwd)/tests. See log (log*.txt) files for details"

( cd tests && make clean )
for c_lib in newlib clib2
do
    export C_LIB=${c_lib}
    cd tests
    make NO_DYN=1 "$@" all
    make all "$@" all
    cd ..
done

_info "The following test artifacts can be transferred to the AmigaOne. "\
"Dynamic tests should include the necessary Shared Objects inside the LHA "\
"file and since ELF.LIBRARY will search in the directory of the program in "\
"preference then the current environment of the AmigaOne should have no "\
"effect."

find tests/ -name "*.lha"

exit 0

